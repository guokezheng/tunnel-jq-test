<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tunnel.business.mapper.bigScreenApi.SdTunnelWarningMapper">
    
    <select id="getTunnelWarningNumber" resultType="java.lang.Long">
        SELECT
--                tbl._date AS countdate,
               IFNULL(sum(tbr.totalnum), 0) AS totalnum
        FROM (
        SELECT @s :=@s + 1 AS _index,DATE(DATE_SUB(CURRENT_DATE, INTERVAL @s DAY)) AS _date
        FROM
        information_schema.tables,(SELECT @s := - 1) temp
        WHERE @s <![CDATA[ < ]]> 29  ORDER BY   _date
        ) AS tbl
        LEFT JOIN (
            SELECT   count(*) AS totalnum,  DATE(warning_time) warningdate
            FROM sd_warning_info where 1=1
            <if test="tunnelId != null and tunnelId != ''">
                AND tunnel_id = #{tunnelId}
            </if>
            GROUP BY  warning_time) AS tbr ON tbl._date = tbr.warningdate
        GROUP BY    tbl._date
    </select>

    <select id="getTunnelWarningNumData" resultType="hashmap">
        SELECT
        tbl._date AS warningDate,
        IFNULL(sum(tbr.totalnum), 0) AS warningNum
        FROM (
        SELECT @s :=@s + 1 AS _index,DATE(DATE_SUB(CURRENT_DATE, INTERVAL @s DAY)) AS _date
        FROM
        information_schema.tables,(SELECT @s := - 1) temp
        WHERE @s <![CDATA[ < ]]> 29  ORDER BY   _date
        ) AS tbl
        LEFT JOIN (
        SELECT   count(*) AS totalnum,  DATE(warning_time) warningdate
        FROM sd_warning_info where 1=1
        <if test="tunnelId != null and tunnelId != ''">
            AND tunnel_id = #{tunnelId}
        </if>
        <if test="startDate != null and startDate != ''">
            AND <![CDATA[ warning_time >= #{startDate} ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            AND <![CDATA[ warning_time <= #{endDate} ]]>
        </if>
        GROUP BY  warning_time) AS tbr ON tbl._date = tbr.warningdate
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND <![CDATA[ tbl._date >= #{startDate} ]]>
        </if>
        <if test="endDate != null and endDate != ''">
            AND <![CDATA[ tbl._date <= #{endDate} ]]>
        </if>
        GROUP BY    tbl._date
    </select>
</mapper>